</head>
<body>
<a href="./index.html" class="back-button" title="Accueil">
        <i class="fas fa-home"></i>
        <span class="back-button-text">Accueil</span>
    </a>

    <div class="container">
        <div class="header">
            <h1>📋 To Do Lists</h1>
            <p class="subtitle">Centre de gestion des tâches pour tous les projets GeekVanlife</p>
        </div>

        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-button forkx active" onclick="switchTab('forkx')">🚗🌵 ForkX</button>
                <button class="tab-button geekomobile" onclick="switchTab('geekomobile')">🚐🚀 Geekomobile</button>
                <button class="tab-button geekagne" onclick="switchTab('geekagne')">🏡🌲 Geekagne</button>
            </div>

            <div id="forkx-tab" class="tab-content active">
                <div class="todo-form-section">
                    <div class="form-title">
                        <span>Ajouter une nouvelle tâche</span>
                        <div class="form-title-actions">
                            <button class="btn-action-icon" onclick="exportTodos('forkx')"
                                title="Exporter les tâches"><i class="fas fa-upload"></i></button>
                            <button class="btn-action-icon" onclick="openJsonImportModal('forkx')"
                                title="Importer les tâches"><i class="fas fa-download"></i></button>
                            <button class="btn-action-icon" onclick="openImageImportModal('forkx')"
                                title="Importer depuis une image"><i class="fas fa-image"></i></button>
                        </div>
                    </div>
                    <div class="form-content">
                        <div class="task-list-row">
                            <div class="task-input-wrapper">
                                <button class="task-input-icon" onclick="addTodo('forkx')" title="Ajouter la tâche"><i
                                        class="fas fa-clipboard-check"></i></button>
                                <input type="text" id="forkx-task-name" placeholder="Nom de la tâche..."
                                    onkeypress="if(event.key==='Enter') addTodo('forkx')"
                                    style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
                            </div>
                            <div class="list-input-group">
                                <select id="forkx-list-select"
                                    style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
                                    <option value="">-- Sélectionner --</option>
                                </select>
                                <button class="list-add-icon" onclick="openListModal('forkx')"
                                    title="Ajouter une liste"><i class="fas fa-tasks"></i></button>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <input type="number" id="forkx-amount" placeholder="Montant (€)" step="0.01">
                            </div>
                            <div class="form-group"
                                style="display: flex; justify-content: center; align-items: center;">
                                <div class="priority-selector">
                                    <button class="priority-btn" data-priority="low"
                                        onclick="selectPriority(this, 'forkx')">🟢</button>
                                    <button class="priority-btn" data-priority="medium"
                                        onclick="selectPriority(this, 'forkx')">🟡</button>
                                    <button class="priority-btn" data-priority="high"
                                        onclick="selectPriority(this, 'forkx')">🔴</button>
                                    <input type="hidden" id="forkx-priority" value="medium">
                                </div>
                            </div>
                        </div>

                        <div class="accordion-section">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <span class="accordion-toggle">+</span>
                                <span>Options supplémentaires</span>
                            </div>
                            <div class="accordion-content">
                                <div class="accordion-body">
                                    <div class="form-group">
                                        <label>Lien (optionnel)</label>
                                        <input type="url" id="forkx-link" placeholder="https://...">
                                    </div>
                                    <div class="form-group">
                                        <label>Note (optionnel)</label>
                                        <textarea id="forkx-note" placeholder="Détails supplémentaires..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-divider"></div>
                <div class="lists-container" id="forkx-lists"></div>
                <div id="forkx-empty" class="empty-state">
                    <div class="empty-state-icon">✅</div>
                    <p>Aucune tâche pour le moment !</p>
                </div>
            </div>

            <div id="geekomobile-tab" class="tab-content">
                <div class="todo-form-section">
                    <div class="form-title">
                        <span>Ajouter une nouvelle tâche</span>
                        <div class="form-title-actions">
                            <button class="btn-action-icon" onclick="exportTodos('geekomobile')"
                                title="Exporter les tâches"><i class="fas fa-upload"></i></button>
                            <button class="btn-action-icon" onclick="openJsonImportModal('geekomobile')"
                                title="Importer les tâches"><i class="fas fa-download"></i></button>
                            <button class="btn-action-icon" onclick="openImageImportModal('geekomobile')"
                                title="Importer depuis une image"><i class="fas fa-image"></i></button>
                        </div>
                    </div>
                    <div class="form-content">
                        <div class="task-list-row">
                            <div class="task-input-wrapper">
                                <button class="task-input-icon" onclick="addTodo('geekomobile')"
                                    title="Ajouter la tâche"><i class="fas fa-clipboard-check"></i></button>
                                <input type="text" id="geekomobile-task-name" placeholder="Nom de la tâche..."
                                    onkeypress="if(event.key==='Enter') addTodo('geekomobile')"
                                    style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
                            </div>
                            <div class="list-input-group">
                                <select id="geekomobile-list-select"
                                    style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
                                    <option value="">-- Sélectionner --</option>
                                </select>
                                <button class="list-add-icon" onclick="openListModal('geekomobile')"
                                    title="Ajouter une liste"><i class="fas fa-tasks"></i></button>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <input type="number" id="geekomobile-amount" placeholder="Montant (€)" step="0.01">
                            </div>
                            <div class="form-group"
                                style="display: flex; justify-content: center; align-items: center;">
                                <div class="priority-selector">
                                    <button class="priority-btn" data-priority="low"
                                        onclick="selectPriority(this, 'geekomobile')">🟢</button>
                                    <button class="priority-btn" data-priority="medium"
                                        onclick="selectPriority(this, 'geekomobile')">🟡</button>
                                    <button class="priority-btn" data-priority="high"
                                        onclick="selectPriority(this, 'geekomobile')">🔴</button>
                                    <input type="hidden" id="geekomobile-priority" value="medium">
                                </div>
                            </div>
                        </div>

                        <div class="accordion-section">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <span class="accordion-toggle">+</span>
                                <span>Options supplémentaires</span>
                            </div>
                            <div class="accordion-content">
                                <div class="accordion-body">
                                    <div class="form-group">
                                        <label>Lien (optionnel)</label>
                                        <input type="url" id="geekomobile-link" placeholder="https://...">
                                    </div>
                                    <div class="form-group">
                                        <label>Note (optionnel)</label>
                                        <textarea id="geekomobile-note"
                                            placeholder="Détails supplémentaires..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-divider"></div>
                <div class="lists-container" id="geekomobile-lists"></div>
                <div id="geekomobile-empty" class="empty-state">
                    <div class="empty-state-icon">✅</div>
                    <p>Aucune tâche pour le moment !</p>
                </div>
            </div>

            <div id="geekagne-tab" class="tab-content">
                <div class="todo-form-section">
                    <div class="form-title">
                        <span>Ajouter une nouvelle tâche</span>
                        <div class="form-title-actions">
                            <button class="btn-action-icon" onclick="exportTodos('geekagne')"
                                title="Exporter les tâches"><i class="fas fa-upload"></i></button>
                            <button class="btn-action-icon" onclick="openJsonImportModal('geekagne')"
                                title="Importer les tâches"><i class="fas fa-download"></i></button>
                            <button class="btn-action-icon" onclick="openImageImportModal('geekagne')"
                                title="Importer depuis une image"><i class="fas fa-image"></i></button>
                        </div>
                    </div>
                    <div class="form-content">
                        <div class="task-list-row">
                            <div class="task-input-wrapper">
                                <button class="task-input-icon" onclick="addTodo('geekagne')"
                                    title="Ajouter la tâche"><i class="fas fa-clipboard-check"></i></button>
                                <input type="text" id="geekagne-task-name" placeholder="Nom de la tâche..."
                                    onkeypress="if(event.key==='Enter') addTodo('geekagne')"
                                    style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
                            </div>
                            <div class="list-input-group">
                                <select id="geekagne-list-select"
                                    style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
                                    <option value="">-- Sélectionner --</option>
                                </select>
                                <button class="list-add-icon" onclick="openListModal('geekagne')"
                                    title="Ajouter une liste"><i class="fas fa-tasks"></i></button>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <input type="number" id="geekagne-amount" placeholder="Montant (€)" step="0.01">
                            </div>
                            <div class="form-group"
                                style="display: flex; justify-content: center; align-items: center;">
                                <div class="priority-selector">
                                    <button class="priority-btn" data-priority="low"
                                        onclick="selectPriority(this, 'geekagne')">🟢</button>
                                    <button class="priority-btn" data-priority="medium"
                                        onclick="selectPriority(this, 'geekagne')">🟡</button>
                                    <button class="priority-btn" data-priority="high"
                                        onclick="selectPriority(this, 'geekagne')">🔴</button>
                                    <input type="hidden" id="geekagne-priority" value="medium">
                                </div>
                            </div>
                        </div>

                        <div class="accordion-section">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <span class="accordion-toggle">+</span>
                                <span>Options supplémentaires</span>
                            </div>
                            <div class="accordion-content">
                                <div class="accordion-body">
                                    <div class="form-group">
                                        <label>Lien (optionnel)</label>
                                        <input type="url" id="geekagne-link" placeholder="https://...">
                                    </div>
                                    <div class="form-group">
                                        <label>Note (optionnel)</label>
                                        <textarea id="geekagne-note"
                                            placeholder="Détails supplémentaires..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-divider"></div>
                <div class="lists-container" id="geekagne-lists"></div>
                <div id="geekagne-empty" class="empty-state">
                    <div class="empty-state-icon">✅</div>
                    <p>Aucune tâche pour le moment !</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal d'import d'image -->
    <div id="image-import-modal" class="image-import-modal">
        <div class="image-import-content">
            <div class="image-import-header">📸 Importer une liste depuis une image</div>

            <!-- Label wrapper pour meilleure accessibilité mobile -->
            <label for="image-input" class="image-upload-zone" id="upload-zone"
                style="cursor: pointer; display: block;">
                <div class="upload-icon"><i class="fas fa-image"></i></div>
                <div class="upload-text">Glissez-déposez une image ici</div>
                <div class="upload-subtext">ou cliquez pour sélectionner une image</div>
                <!-- Input file caché mais dans le label pour meilleure accessibilité -->
                <input type="file" id="image-input" accept="image/*" onchange="handleImageSelect(event)"
                    style="display:none;">
            </label>

            <div id="processing-container" style="display:none;">
                <div class="processing-indicator">
                    <div class="spinner"></div>
                    <p>Analyse de l'image en cours...</p>
                </div>
            </div>

            <div id="image-preview" class="image-preview" style="display:none;">
                <img id="preview-img" src="" alt="Aperçu">
            </div>

            <div id="ocr-container" style="display:none;">
                <label>Texte détecté :</label>
                <div class="ocr-result" id="ocr-result"></div>
            </div>

            <div id="todo-preview-container" style="display:none;">
                <label>Tâches extraites :</label>
                <div class="todo-preview-list" id="todo-preview-list"></div>
            </div>

            <div id="import-actions-container" style="display:none;" class="import-actions">
                <button id="btn-import-image" class="btn-import" onclick="importFromImage()">Importer ces
                    tâches</button>
                <button class="btn-close-import" onclick="closeImageImportModal()">Annuler</button>
            </div>

            <div id="no-import-actions" class="import-actions">
                <button class="btn-close-import" onclick="closeImageImportModal()" style="flex:1;">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal d'import JSON -->
    <div id="json-import-modal" class="image-import-modal">
        <div class="image-import-content">
            <div class="image-import-header">📥 Importer un fichier JSON</div>

            <div class="image-upload-zone" id="json-upload-zone"
                onclick="document.getElementById('json-import-input').click()">
                <div class="upload-icon"><i class="fas fa-file-import"></i></div>
                <div class="upload-text">Cliquez pour sélectionner un fichier</div>
                <div class="upload-subtext">ou glissez-déposez un fichier JSON ici</div>
            </div>

            <input type="file" id="json-import-input" accept=".json" onchange="handleJsonImportSelect(event)">

            <div id="json-import-actions" class="import-actions">
                <button class="btn-close-import" onclick="closeJsonImportModal()" style="flex:1;">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal de synchronisation universelle -->
    <div id="sync-modal" class="image-import-modal">
        <div class="image-import-content">
            <div class="image-import-header">🔄 Code de Partage Universel</div>

            <div style="padding: 20px;">
                <div style="margin-bottom: 20px; padding: 10px; background: #f0f4ff; border-radius: 8px;">
                    <p style="margin: 0; color: #333; font-size: 0.95rem;">
                        <strong>✨ Partagez toutes vos données</strong> (todos, paramètres, et tout le contenu de votre
                        application) entre vos appareils sans importer/exporter !
                    </p>
                </div>

                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <label style="display: block; text-align: left; margin-bottom: 8px; font-weight: 600;">🔐 Votre code
                        de partage :</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="sync-code" readonly
                            style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; background: white;"
                            placeholder="SHARE-00000-00000">
                        <button onclick="copySyncCode()"
                            style="padding: 10px 15px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; white-space: nowrap;">📋
                            Copier</button>
                    </div>
                    <p style="margin: 8px 0 0 0; font-size: 0.8rem; color: #999;">Valide 7 jours - Partagez ce code avec
                        vos autres appareils</p>
                </div>

                <div style="background: #f0f4ff; padding: 15px; border-radius: 8px;">
                    <label style="display: block; text-align: left; margin-bottom: 8px; font-weight: 600;">🔗 Restaurer
                        à partir d'un code :</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="sync-code-input" placeholder="0001XXXXX"
                            style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace;">
                        <button onclick="syncWithCode()"
                            style="padding: 10px 15px; background: #11998e; color: white; border: none; border-radius: 6px; cursor: pointer; white-space: nowrap;">✓
                            Restaurer</button>
                    </div>
                    <p style="margin: 8px 0 0 0; font-size: 0.8rem; color: #999;">Entrez le code reçu d'un autre
                        appareil</p>
                </div>
            </div>

            <div class="import-actions">
                /*
                const firebaseConfig = {
                apiKey: "AIzaSyD7PUqS5GGpEuQiZhlaiwhBpiJps5K8Jec",
                authDomain: "geekvanlife.firebaseapp.com",
                projectId: "geekvanlife",
                storageBucket: "geekvanlife.firebasestorage.app",
                messagingSenderId: "808193116530",
                appId: "1:808193116530:web:26d0f44d6258e7933c75eb",
                databaseURL: "https://geekvanlife-default-rtdb.europe-west1.firebasedatabase.app"
                };

                // Initialize Firebase
                let firebaseDB = null;
                let firebaseRef = null;
                let firebaseSet = null;
                let firebaseGet = null;
                let firebaseOnValue = null;

                try {
                if (typeof firebase === 'undefined') {
                console.error('❌ Firebase SDK not loaded');
                document.getElementById('firebase-status').innerHTML = '❌ Firebase SDK non chargé';
                } else {
                firebase.initializeApp(firebaseConfig);
                firebaseDB = firebase.database();
                firebaseRef = (path) => firebaseDB.ref(path);
                firebaseSet = (ref, data) => ref.set(data);
                firebaseGet = (ref) => ref.once('value');
                firebaseOnValue = (ref, callback, errorCallback) => ref.on('value', callback, errorCallback);

                // Exposer globalement
                window.firebaseDB = firebaseDB;
                window.firebaseRef = firebaseRef;
                window.firebaseSet = firebaseSet;
                window.firebaseGet = firebaseGet;
                window.firebaseOnValue = firebaseOnValue;

                console.log('✅ Firebase initialized successfully');
                }
                } catch (error) {
                console.error('Firebase initialization error:', error);
                document.getElementById('firebase-status').innerHTML = '❌ Erreur init Firebase';
                }
                */

                const projects = {
                forkx: { storageKey: 'forkx-todos', displayColor: 'forkx' },
                geekomobile: { storageKey: 'geekomobile-todos', displayColor: 'geekomobile' },
                geekagne: { storageKey: 'geekagne-todos', displayColor: 'geekagne' }
                };

                /**
                * Crée un code de partage unique pour TOUTES les données de l'app
                * Format: SHARE-TIMESTAMP-RANDOM
                */
                function generateShareCode() {
                const timestamp = Math.floor(Date.now() / 1000);
                const random = Math.floor(Math.random() * 100000).toString().padStart(5, '0');
                return `${timestamp.toString().slice(-5)}${random}`;
                }

                function getAllApplicationData() {
                const data = {};
                for (let i = 0; i < localStorage.length; i++) { const key=localStorage.key(i); if
                    (!key.startsWith('sync_')) { data[key]=localStorage.getItem(key); } } return data; } function
                    saveShareCode(code, appData) { const shareEntry={ data: appData, timestamp: Date.now(), expiry:
                    Date.now() + (7 * 24 * 60 * 60 * 1000) }; localStorage.setItem(`sync_${code}`,
                    JSON.stringify(shareEntry)); } function loadShareCode(code) { const
                    shareEntry=localStorage.getItem(`sync_${code}`); if (!shareEntry) return null; const
                    entry=JSON.parse(shareEntry); if (Date.now()> entry.expiry) {
                    localStorage.removeItem(`sync_${code}`);
                    return null;
                    }
                    return entry.data;
                    }

                    /**
                    * Ouvre la modal de synchronisation
                    */
                    function openSyncModal() {
                    const modal = document.getElementById('sync-modal');
                    modal.classList.add('active');

                    // Vérifier s'il existe déjà un code valide
                    let shareCode = localStorage.getItem('current_share_code');

                    // Générer un nouveau code seulement s'il n'existe pas ou est expiré
                    if (!shareCode || !loadShareCode(shareCode)) {
                    shareCode = generateShareCode();
                    const allAppData = getAllApplicationData();
                    saveShareCode(shareCode, allAppData);
                    localStorage.setItem('current_share_code', shareCode);
                    }

                    document.getElementById('sync-code').value = shareCode;
                    document.getElementById('sync-code-input').value = '';
                    }

                    /**
                    * Ferme la modal de synchronisation
                    */
                    function closeSyncModal() {
                    document.getElementById('sync-modal').classList.remove('active');
                    }

                    /**
                    * Copie le code de partage dans le presse-papiers
                    */
                    function copySyncCode() {
                    const code = document.getElementById('sync-code').value;
                    navigator.clipboard.writeText(code).then(() => {
                    alert('✓ Code copié ! Vous pouvez maintenant le partager');
                    }).catch(() => {
                    alert('Erreur lors de la copie. Code: ' + code);
                    });
                    }

                    /**
                    * Synchronise l'application avec un code de partage
                    * Restaure TOUTES les données exportées
                    */
                    function syncWithCode() {
                    const code = document.getElementById('sync-code-input').value.trim();
                    if (!code) {
                    alert('Veuillez entrer un code');
                    return;
                    }

                    const shareData = loadShareCode(code);
                    if (!shareData) {
                    alert('❌ Code invalide ou expiré');
                    return;
                    }

                    if (!confirm('⚠️ Ceci remplacera toutes vos données actuelles.\n\nContinuer ?')) {
                    return;
                    }

                    Object.keys(shareData).forEach(key => {
                    localStorage.setItem(key, shareData[key]);
                    });

                    alert('✓ Synchronisation réussie !\n\nRafraîchissez la page pour voir les changements.');
                    closeSyncModal();
                    location.reload();
                    closeSyncModal();

                    // Rafraîchir tous les projets
                    Object.keys(projects).forEach(projectId => {
                    updateListSelect(projectId);
                    renderTodos(projectId);
                    });
                    }

                    function toggleAccordion(header) {
                    const content = header.nextElementSibling;
                    const toggle = header.querySelector('.accordion-toggle');
                    content.classList.toggle('open');
                    toggle.classList.toggle('open');
                    }

                    function selectPriority(btn, projectId) {
                    const selector = btn.parentElement;
                    selector.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    document.getElementById(projectId + '-priority').value = btn.dataset.priority;
                    }

                    function switchTab(projectId) {
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.getElementById(projectId + '-tab').classList.add('active');

                    // Activer le bouton correspondant
                    const targetButton = document.querySelector(`[onclick*="${projectId}"]`);
                    if (targetButton) {
                    targetButton.classList.add('active');
                    }

                    updateListSelect(projectId);
                    renderTodos(projectId);
                    }

                    function openListModal(projectId) {
                    const listName = prompt('Entrez le nom de la nouvelle liste:');
                    if (listName && listName.trim()) {
                    // La liste sera ajoutée automatiquement quand on ajoute une tâche
                    alert('La liste sera créée quand vous ajouterez la première tâche');
                    }
                    }

                    function updateListSelect(projectId) {
                    const todos = loadTodos(projectId);
                    const lists = new Set();
                    todos.forEach(todo => { if (todo.list) lists.add(todo.list); });

                    const select = document.getElementById(projectId + '-list-select');
                    const currentValue = select.value;
                    const listOptions = Array.from(lists).sort();

                    select.innerHTML = '<option value="">-- Sélectionner une liste --</option>' +
                    listOptions.map(list => `<option value="${escapeHtml(list)}">${escapeHtml(list)}</option>
                    `).join('');

                    if (listOptions.includes(currentValue)) {
                    select.value = currentValue;
                    }
                    }

                    function loadTodos(projectId) {
                    return JSON.parse(localStorage.getItem(projects[projectId].storageKey)) || [];
                    }

                    // Écouter les changements Firebase en temps réel
                    /* FIREBASE SYNC - DÉSACTIVÉ
                    function watchFirebaseChanges() {
                    if (!window.firebaseDB || !window.firebaseOnValue) {
                    console.warn('Firebase watch: Firebase not available');
                    return;
                    }

                    Object.keys(projects).forEach(projectId => {
                    try {
                    const dbRef = window.firebaseRef(`todos/${projectId}`);

                    // onValue requires proper callback structure
                    window.firebaseOnValue(
                    dbRef,
                    (snapshot) => {
                    try {
                    if (snapshot.exists()) {
                    const firebaseData = snapshot.val();
                    const remoteData = firebaseData && firebaseData.data ? firebaseData.data : [];
                    const storageKey = projects[projectId].storageKey;
                    const localData = JSON.parse(localStorage.getItem(storageKey)) || [];

                    // Synchroniser si les données distantes sont différentes
                    if (JSON.stringify(localData) !== JSON.stringify(remoteData)) {
                    console.log(`📥 Données Firebase reçues pour ${projectId}`);
                    localStorage.setItem(storageKey, JSON.stringify(remoteData));
                    // Rafraîchir l'affichage si l'onglet est actif
                    const activeTab = document.querySelector('.tab-content.active');
                    if (activeTab && activeTab.id === `${projectId}-tab`) {
                    renderTodos(projectId);
                    }
                    }
                    }
                    } catch (error) {
                    console.error(`Error processing Firebase update for ${projectId}:`, error);
                    }
                    },
                    (error) => {
                    console.warn(`Firebase watch error for ${projectId}:`, error);
                    }
                    );
                    } catch (error) {
                    console.warn(`Firebase watch setup error for ${projectId}:`, error);
                    }
                    });
                    console.log('🔄 Firebase real-time sync activated');
                    }

                    // Charger les données Firebase au démarrage
                    function loadDataFromFirebase() {
                    console.log('🔵 Début loadDataFromFirebase');
                    const statusEl = document.getElementById('firebase-status');

                    if (!window.firebaseDB || !window.firebaseGet) {
                    console.error('❌ Firebase not available - firebaseDB:', window.firebaseDB, 'firebaseGet:',
                    window.firebaseGet);
                    if (statusEl) statusEl.innerHTML = '❌ Firebase non disponible';
                    return Promise.resolve();
                    }

                    console.log('✅ Firebase disponible, lecture des projets:', Object.keys(projects));
                    if (statusEl) statusEl.innerHTML = '🔄 Chargement depuis Firebase...';

                    return Promise.all(Object.keys(projects).map(projectId => {
                    console.log(`📖 Chargement pour ${projectId}...`);
                    try {
                    const dbRef = window.firebaseRef(`todos/${projectId}`);
                    console.log(`📍 Référence créée pour ${projectId}:`, dbRef);

                    return window.firebaseGet(dbRef).then((snapshot) => {
                    console.log(`📦 Snapshot reçu pour ${projectId}:`, snapshot.exists(), snapshot.val());

                    if (snapshot.exists()) {
                    const firebaseData = snapshot.val();
                    console.log(`📄 Données Firebase brutes ${projectId}:`, firebaseData);

                    const remoteData = firebaseData && firebaseData.data ? firebaseData.data : [];
                    console.log(`✔️ Données extraites ${projectId}:`, remoteData);

                    if (Array.isArray(remoteData)) {
                    const storageKey = projects[projectId].storageKey;
                    localStorage.setItem(storageKey, JSON.stringify(remoteData));
                    console.log(`✅ Données Firebase chargées pour ${projectId} (${remoteData.length} tâches)`);
                    console.log(`💾 localStorage[${storageKey}]:`, localStorage.getItem(storageKey));
                    } else {
                    console.warn(`❌ Format invalide pour ${projectId}:`, remoteData);
                    }
                    } else {
                    console.log(`ℹ️ Aucune donnée Firebase pour ${projectId}`);
                    }
                    }).catch(error => {
                    console.error(`❌ Erreur lecture Firebase ${projectId}:`, error);
                    if (statusEl) statusEl.innerHTML = `❌ Erreur Firebase: ${error.message}`;
                    });
                    } catch (error) {
                    console.error(`❌ Erreur Firebase ${projectId}:`, error);
                    if (statusEl) statusEl.innerHTML = `❌ Erreur: ${error.message}`;
                    return Promise.resolve();
                    }
                    })).then(() => {
                    console.log('🟢 loadDataFromFirebase TERMINÉ');
                    if (statusEl) statusEl.innerHTML = '✅ Synchronisé avec Firebase';
                    setTimeout(() => { if (statusEl) statusEl.style.display = 'none'; }, 3000);
                    });
                    }
                    */

                    function saveTodos(projectId, todos) {
                    const storageKey = projects[projectId].storageKey;
                    localStorage.setItem(storageKey, JSON.stringify(todos));

                    /* FIREBASE SYNC - DÉSACTIVÉ
                    // Synchronise avec Firebase
                    if (window.firebaseDB) {
                    try {
                    const dbRef = window.firebaseRef(`todos/${projectId}`);
                    window.firebaseSet(dbRef, {
                    data: todos,
                    lastUpdated: new Date().toISOString()
                    }).then(() => {
                    console.log(`📤 Données sauvegardées dans Firebase pour ${projectId}`);
                    }).catch(error => {
                    console.error(`Erreur Firebase sync ${projectId}:`, error);
                    });
                    } catch (error) {
                    console.warn('Firebase not available, using local storage only:', error);
                    }
                    }
                    */
                    }

                    function addTodo(projectId) {
                    const taskName = document.getElementById(projectId + '-task-name').value.trim();
                    const listSelect = document.getElementById(projectId + '-list-select');
                    let listName = listSelect.value.trim();
                    const priority = document.getElementById(projectId + '-priority').value;
                    const amount = document.getElementById(projectId + '-amount').value;
                    let link = document.getElementById(projectId + '-link').value.trim();
                    const note = document.getElementById(projectId + '-note').value.trim();

                    if (!taskName) {
                    alert('Veuillez remplir le nom de la tâche');
                    return;
                    }

                    // Si pas de liste sélectionnée, utiliser une liste vide (sans nom)
                    // Au lieu de demander à l'utilisateur de créer une liste
                    if (!listName) {
                    listName = ''; // Liste par défaut sans nom
                    }

                    // Ajouter le préfixe https:// si absent
                    if (link && !link.match(/^https?:\/\//i)) {
                    link = 'https://' + link;
                    }

                    const todos = loadTodos(projectId);
                    todos.push({
                    id: Date.now(),
                    list: listName,
                    name: taskName,
                    priority: priority,
                    amount: amount ? parseFloat(amount) : null,
                    link: link,
                    note: note,
                    completed: false,
                    parentId: null
                    });

                    saveTodos(projectId, todos);

                    // Clear form
                    document.getElementById(projectId + '-task-name').value = '';
                    listSelect.value = '';
                    document.getElementById(projectId + '-amount').value = '';
                    document.getElementById(projectId + '-link').value = '';
                    document.getElementById(projectId + '-note').value = '';
                    document.getElementById(projectId + '-priority').value = 'medium';
                    document.querySelectorAll(`#${projectId}-tab .priority-btn`).forEach(b =>
                    b.classList.remove('selected'));
                    document.querySelectorAll(`#${projectId}-tab .priority-btn[data-priority="medium"]`).forEach(b =>
                    b.classList.add('selected'));

                    updateListSelect(projectId);
                    renderTodos(projectId);
                    }

                    function openEditModal(projectId, todoId) {
                    const todos = loadTodos(projectId);
                    const todo = todos.find(t => t.id === todoId);
                    if (!todo) return;

                    // Créer la modal
                    let modal = document.getElementById('edit-modal');
                    if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'edit-modal';
                    modal.className = 'edit-modal';
                    modal.onclick = function (e) {
                    if (e.target === modal) closeEditModal();
                    };
                    document.body.appendChild(modal);
                    }

                    modal.innerHTML = `
                    <div class="edit-modal-content">
                        <div class="edit-modal-header">Éditer la tâche</div>
                        <form class="edit-modal-form"
                            onsubmit="saveEditModal('${projectId}', ${todoId}); return false;">
                            <div class="form-group">
                                <label>Nom de la tâche</label>
                                <input type="text" id="edit-name" value="${escapeHtml(todo.name)}" required>
                            </div>
                            <div class="form-group">
                                <label>Liste</label>
                                <input type="text" id="edit-list" value="${escapeHtml(todo.list)}" required>
                            </div>
                            <div class="form-group">
                                <label>Priorité</label>
                                <select id="edit-priority">
                                    <option value="low" ${todo.priority==='low' ? 'selected' : '' }>Basse (🟢)</option>
                                    <option value="medium" ${todo.priority==='medium' ? 'selected' : '' }>Moyenne (🟡)
                                    </option>
                                    <option value="high" ${todo.priority==='high' ? 'selected' : '' }>Haute (🔴)
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Montant (€)</label>
                                <input type="number" id="edit-amount" value="${todo.amount || ''}" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Lien</label>
                                <input type="text" id="edit-link" value="${escapeHtml(todo.link || '')}"
                                    placeholder="exemple.com">
                            </div>
                            <div class="form-group">
                                <label>Note</label>
                                <textarea id="edit-note">${escapeHtml(todo.note || '')}</textarea>
                            </div>
                            <div class="edit-modal-actions">
                                <button type="submit" class="btn-save">Enregistrer</button>
                                <button type="button" class="btn-cancel" onclick="closeEditModal()">Annuler</button>
                            </div>
                        </form>
                    </div>
                    `;
                    modal.classList.add('active');
                    }

                    function closeEditModal() {
                    const modal = document.getElementById('edit-modal');
                    if (modal) modal.classList.remove('active');
                    }

                    function saveEditModal(projectId, todoId) {
                    const todos = loadTodos(projectId);
                    const todo = todos.find(t => t.id === todoId);
                    if (!todo) return;

                    todo.name = document.getElementById('edit-name').value.trim();
                    todo.list = document.getElementById('edit-list').value.trim();
                    todo.priority = document.getElementById('edit-priority').value;
                    const amount = parseFloat(document.getElementById('edit-amount').value);
                    todo.amount = isNaN(amount) ? null : amount;

                    // Ajouter le préfixe https:// si absent
                    let link = document.getElementById('edit-link').value.trim();
                    if (link && !link.match(/^https?:\/\//i)) {
                    link = 'https://' + link;
                    }
                    todo.link = link;
                    todo.note = document.getElementById('edit-note').value.trim();

                    saveTodos(projectId, todos);
                    closeEditModal();
                    updateListSelect(projectId);
                    renderTodos(projectId);
                    }

                    function toggleTodo(projectId, todoId) {
                    const todos = loadTodos(projectId);
                    const todo = todos.find(t => t.id === todoId);
                    if (!todo) return;

                    // Si on essaie de cocher, vérifier les enfants
                    if (!todo.completed) {
                    if (!canToggleTodo(todos, todoId, false)) {
                    return;
                    }
                    }

                    todo.completed = !todo.completed;
                    saveTodos(projectId, todos);
                    renderTodos(projectId);
                    }

                    function deleteTodo(projectId, todoId) {
                    const todos = loadTodos(projectId);
                    const descendants = getAllDescendants(todos, todoId);
                    const descendantCount = descendants.length;

                    let message = 'Êtes-vous sûr de vouloir supprimer cette tâche ?';
                    if (descendantCount > 0) {
                    message += `\n\nAttention : Cette tâche a ${descendantCount} sous-tâche${descendantCount > 1 ? 's' :
                    ''}. Celles-ci seront aussi supprimées.`;
                    }

                    if (confirm(message)) {
                    // Supprimer la tâche et tous ses descendants
                    const idsToDelete = new Set([todoId]);
                    descendants.forEach(d => idsToDelete.add(d.id));

                    const filtered = todos.filter(t => !idsToDelete.has(t.id));
                    saveTodos(projectId, filtered);
                    updateListSelect(projectId);
                    renderTodos(projectId);
                    }
                    }

                    function getPriorityClass(priority) {
                    const classes = { 'low': 'priority-low', 'medium': 'priority-medium', 'high': 'priority-high' };
                    return classes[priority] || 'priority-medium';
                    }

                    function escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                    }

                    // Variables globales pour l'import d'image
                    let currentImageProjectId = null;
                    let extractedTodos = [];

                    function openImageImportModal(projectId) {
                    currentImageProjectId = projectId;
                    extractedTodos = [];
                    document.getElementById('image-import-modal').classList.add('active');

                    // Réinitialiser le formulaire
                    document.getElementById('image-input').value = '';
                    document.getElementById('image-preview').style.display = 'none';
                    document.getElementById('ocr-container').style.display = 'none';
                    document.getElementById('todo-preview-container').style.display = 'none';
                    document.getElementById('import-actions-container').style.display = 'none';
                    document.getElementById('processing-container').style.display = 'none';
                    document.getElementById('no-import-actions').style.display = 'flex';

                    // Setup drag & drop sur la zone (pas de click handler car c'est un label)
                    const uploadZone = document.getElementById('upload-zone');
                    const imageInput = document.getElementById('image-input');

                    if (uploadZone && imageInput) {
                    // Drag & drop handlers
                    uploadZone.ondragover = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    uploadZone.classList.add('dragover');
                    };

                    uploadZone.ondragleave = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    uploadZone.classList.remove('dragover');
                    };

                    uploadZone.ondrop = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    uploadZone.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                    imageInput.files = e.dataTransfer.files;
                    handleImageSelect({ target: { files: e.dataTransfer.files } });
                    }
                    };
                    }
                    }


                    function closeImageImportModal() {
                    document.getElementById('image-import-modal').classList.remove('active');
                    currentImageProjectId = null;
                    extractedTodos = [];
                    }

                    function openJsonImportModal(projectId) {
                    currentImageProjectId = projectId; // Réutiliser la même variable
                    document.getElementById('json-import-modal').classList.add('active');

                    // Réinitialiser le formulaire
                    document.getElementById('json-import-input').value = '';

                    // Setup drag & drop pour JSON
                    const uploadZone = document.getElementById('json-upload-zone');
                    uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('dragover');
                    });
                    uploadZone.addEventListener('dragleave', () => {
                    uploadZone.classList.remove('dragover');
                    });
                    uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file && file.type === 'application/json') {
                    document.getElementById('json-import-input').files = e.dataTransfer.files;
                    handleJsonImportSelect({ target: { files: e.dataTransfer.files } });
                    }
                    });
                    }

                    function closeJsonImportModal() {
                    document.getElementById('json-import-modal').classList.remove('active');
                    currentImageProjectId = null;
                    }

                    function handleJsonImportSelect(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                    try {
                    const projectId = currentImageProjectId;
                    if (!projectId) {
                    alert('Erreur : projet non sélectionné');
                    return;
                    }

                    // Appeler la fonction d'import JSON existante
                    importTodos(projectId, { target: { files: [file] } });
                    closeJsonImportModal();
                    } catch (error) {
                    alert('Erreur lors de l\'import : fichier invalide ou corrompu');
                    console.error(error);
                    }
                    };
                    reader.readAsText(file);
                    }

                    function handleImageSelect(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                    const imageSrc = e.target.result;

                    // Afficher l'aperçu
                    document.getElementById('preview-img').src = imageSrc;
                    document.getElementById('image-preview').style.display = 'block';
                    document.getElementById('no-import-actions').style.display = 'none';

                    // Afficher le spinner
                    document.getElementById('processing-container').style.display = 'block';
                    document.getElementById('ocr-container').style.display = 'none';
                    document.getElementById('todo-preview-container').style.display = 'none';
                    document.getElementById('import-actions-container').style.display = 'none';

                    // OCR avec Tesseract
                    try {
                    const { data: { text } } = await Tesseract.recognize(imageSrc, 'fra+eng');

                    // Afficher le texte détecté
                    document.getElementById('ocr-result').textContent = text;
                    document.getElementById('ocr-container').style.display = 'block';

                    // Extraire les tâches
                    extractedTodos = parseTodoListFromText(text);

                    // Afficher l'aperçu des tâches
                    if (extractedTodos.length > 0) {
                    displayTodoPreview();
                    document.getElementById('import-actions-container').style.display = 'flex';
                    } else {
                    alert('Aucune tâche détectée. Vérifiez que l\'image contient une liste de tâches.');
                    }
                    } catch (error) {
                    console.error('Erreur OCR:', error);
                    alert('Erreur lors de l\'analyse de l\'image : ' + error.message);
                    } finally {
                    document.getElementById('processing-container').style.display = 'none';
                    }
                    };
                    reader.readAsDataURL(file);
                    }

                    function parseTodoListFromText(text) {
                    const todos = [];
                    const lines = text.split('\\n').filter(line => line.trim());

                    // Patterns pour détecter les tâches complétées
                    const completedPatterns = [
                    /^\\s*✓|^\\s*✔|^\\s*☑|strikethrough/i,
                    /^\\s*\\[x\\]|^\\s*\\(x\\)|^\\s*•\\s*(strikethrough)?/i
                    ];

                    lines.forEach((line, index) => {
                    const trimmed = line.trim();
                    if (!trimmed || trimmed.length < 3) return; // Détecter si la tâche est complétée const
                        completed=/^\\s*✓|^\\s*✔|^\\s*☑|^\\s*\\[x\\]|^\\s*\\(x\\)/.test(line); // Nettoyer la ligne let
                        taskName=trimmed .replace(/^[✓✔☑\\[x\\]\\(x\\)•~-]+\\s*/, '' ) // Supprimer les marqueurs
                        .replace(/^\\s*[-•*]\\s*/, '' ) // Supprimer les puces .trim(); // Détecter la priorité (emoji
                        ou mots-clés) let priority='medium' ; if (/🟢|basse|low/i.test(taskName)) { priority='low' ;
                        taskName=taskName.replace(/🟢|basse|low/i, '' ).trim(); } else if
                        (/🔴|haute|high|urgent/i.test(taskName)) { priority='high' ;
                        taskName=taskName.replace(/🔴|haute|high|urgent/i, '' ).trim(); } // Détecter les montants (€,
                        $, EUR) const amountMatch=taskName.match(/(\\d+[.,]\\d{0,2})\\s*[€$EUR]/); let amount=null; if
                        (amountMatch) { amount=parseFloat(amountMatch[1].replace(',', '.' ));
                        taskName=taskName.replace(amountMatch[0], '' ).trim(); } if (taskName && taskName.length> 2) {
                        todos.push({
                        id: Date.now() + Math.random() * 1000000,
                        list: 'Importée', // Liste par défaut
                        name: taskName,
                        priority: priority,
                        amount: amount,
                        link: '',
                        note: '',
                        completed: completed,
                        parentId: null
                        });
                        }
                        });

                        return todos;
                        }

                        function displayTodoPreview() {
                        const previewHtml = extractedTodos.map((todo, index) => `
                        <div class="todo-preview-item ${todo.completed ? 'completed' : ''}">
                            <strong>${escapeHtml(todo.name)}</strong>
                            ${todo.amount ? `<span> • ${todo.amount}€</span>` : ''}
                            <span> • ${todo.priority === 'low' ? '🟢' : todo.priority === 'high' ? '🔴' : '🟡'}</span>
                            ${todo.completed ? ' <span style="opacity: 0.5;">(complétée)</span>' : ''}
                        </div>
                        `).join('');

                        document.getElementById('todo-preview-list').innerHTML = previewHtml;
                        document.getElementById('todo-preview-container').style.display = 'block';
                        }

                        function importFromImage() {
                        if (!currentImageProjectId || extractedTodos.length === 0) {
                        alert('Aucune tâche à importer');
                        return;
                        }

                        const todos = loadTodos(currentImageProjectId);
                        const existingCount = todos.length;

                        extractedTodos.forEach(todo => {
                        todos.push(todo);
                        });

                        saveTodos(currentImageProjectId, todos);
                        updateListSelect(currentImageProjectId);
                        renderTodos(currentImageProjectId);

                        alert(`${extractedTodos.length} tâche(s) importée(s) avec succès !`);
                        closeImageImportModal();
                        }

                        function exportTodos(projectId) {
                        const todos = loadTodos(projectId);
                        const now = new Date();
                        const dateStr = now.toISOString().split('T')[0];

                        const exportData = {
                        project: projectId,
                        exportDate: now.toISOString(),
                        todosCount: todos.length,
                        todos: todos
                        };

                        const dataStr = JSON.stringify(exportData, null, 2);
                        const dataBlob = new Blob([dataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(dataBlob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `GeekVanlife-${projectId}-${dateStr}.json`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        }

                        function importTodos(projectId, event) {
                        const file = event.target.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        reader.onload = function (e) {
                        try {
                        const importedData = JSON.parse(e.target.result);

                        // Validation basique
                        if (!importedData.todos || !Array.isArray(importedData.todos)) {
                        alert('Fichier invalide : structure incorrecte');
                        return;
                        }

                        // Vérifier que le projet correspond
                        if (importedData.project !== projectId) {
                        const confirm_import = confirm(
                        `Le fichier est pour le projet "${importedData.project}" mais vous êtes sur
                        "${projectId}".\n\nVoulez-vous continuer l'import ? Les données existantes seront fusionnées.`
                        );
                        if (!confirm_import) {
                        event.target.value = '';
                        return;
                        }
                        }

                        // Fusionner avec les données existantes
                        const existingTodos = loadTodos(projectId);
                        const mergedTodos = [...existingTodos];
                        let importedCount = 0;
                        let skippedCount = 0;

                        // Ajouter les tâches importées avec validation et valeurs par défaut
                        importedData.todos.forEach(importedTodo => {
                        const exists = mergedTodos.some(t => t.id === importedTodo.id);
                        if (exists) {
                        skippedCount++;
                        return;
                        }

                        // Normaliser les données avec valeurs par défaut
                        const normalizedTodo = {
                        id: importedTodo.id || Date.now() + Math.random(),
                        list: (importedTodo.list || '').trim() || 'Sans liste',
                        name: (importedTodo.name || '').trim() || '(Sans nom)',
                        priority: ['low', 'medium', 'high'].includes(importedTodo.priority) ? importedTodo.priority :
                        'medium',
                        amount: importedTodo.amount ? parseFloat(importedTodo.amount) : null,
                        link: (importedTodo.link || '').trim() || '',
                        note: (importedTodo.note || '').trim() || '',
                        completed: importedTodo.completed === true ? true : false,
                        parentId: importedTodo.parentId || null
                        };

